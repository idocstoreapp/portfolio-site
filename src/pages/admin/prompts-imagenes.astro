---
// P√°gina admin para ver TODOS los prompts de im√°genes que el sistema puede generar
// Esto permite al administrador ver todos los prompts y generar las im√°genes necesarias

import Layout from '../../layouts/AdminLayout.astro';
import AdminGuard from '../../components/admin/AdminGuard';
import AdminSidebar from '../../components/admin/AdminSidebar';
import { getUniqueImagePrompts, type ImagePromptInfo } from '../../utils/getAllImagePrompts';

export const prerender = false;
const currentPath = Astro.url.pathname;

// Obtener todos los prompts √∫nicos
const uniquePrompts = getUniqueImagePrompts();

// Agrupar por sector para mejor organizaci√≥n
const promptsBySector = new Map<string, ImagePromptInfo[]>();
uniquePrompts.forEach(prompt => {
  const sector = prompt.sector;
  if (!promptsBySector.has(sector)) {
    promptsBySector.set(sector, []);
  }
  promptsBySector.get(sector)!.push(prompt);
});

const sectorNames: Record<string, string> = {
  'restaurante': 'Restaurante / Bar / Caf√©',
  'servicio-tecnico': 'Servicio T√©cnico',
  'taller': 'Taller Mec√°nico',
  'fabrica': 'F√°brica / Muebler√≠a',
  'comercio': 'Comercio / Tienda',
  'servicios': 'Servicios'
};
---

<Layout 
  title="Prompts de Im√°genes | Panel de Administraci√≥n"
  description="Lista de todos los prompts de im√°genes que el sistema puede generar"
>
  <AdminGuard client:load>
    <div style="position: relative; min-height: 100vh; background: #f9fafb;">
      <AdminSidebar client:load currentPath={currentPath} />
      <div style="margin-left: 16rem; min-height: 100vh; width: calc(100% - 16rem);">
        <div className="p-6 max-w-7xl mx-auto">
          <div className="mb-8">
            <h1 className="text-3xl font-bold text-gray-900 mb-2">
              Prompts de Im√°genes del Wizard
            </h1>
            <p className="text-gray-600">
              Lista completa de todos los prompts de im√°genes que el sistema puede generar.
              Total: <strong>{uniquePrompts.length}</strong> im√°genes √∫nicas necesarias.
            </p>
            <p className="text-sm text-gray-500 mt-2">
              Usa estos prompts para generar las im√°genes con DALL-E, Midjourney u otra herramienta.
              Guarda las im√°genes con los nombres sugeridos en <code>/public/images/diagnosticos/</code>
            </p>
          </div>

          {Array.from(promptsBySector.entries()).map(([sector, prompts]) => (
            <div key={sector} className="mb-8">
              <h2 className="text-2xl font-semibold text-gray-900 mb-4 pb-2 border-b-2 border-gray-300">
                {sectorNames[sector] || sector} 
                <span className="text-lg font-normal text-gray-500 ml-2">({prompts.length} im√°genes)</span>
              </h2>

              <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                {prompts.map((prompt, index) => (
                  <div key={`${prompt.questionId}-${prompt.answerValue}`} className="bg-white rounded-xl shadow-md border border-gray-200 hover:shadow-lg transition-shadow flex flex-col">
                    <div className="p-5 flex-1 flex flex-col">
                      <div className="flex items-start justify-between mb-3">
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2 mb-2">
                            <span className="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold bg-blue-600 text-white flex-shrink-0">
                              {index + 1}
                            </span>
                            <h3 className="text-base font-semibold text-gray-900 leading-tight break-words">
                              {prompt.questionTitle}
                            </h3>
                          </div>
                          <p className="text-sm text-gray-600 ml-8 mb-3 break-words">
                            <strong className="text-gray-700">Respuesta:</strong> {prompt.answerLabel}
                          </p>
                        </div>
                      </div>

                      <div className="bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-4 mb-3 border border-gray-200 flex-1 flex flex-col min-h-0">
                        <div className="flex items-center justify-between mb-2 flex-shrink-0">
                          <span className="text-xs font-semibold text-gray-700 uppercase tracking-wide">Prompt</span>
                          <button 
                            class="copy-prompt-btn text-xs text-blue-600 hover:text-blue-800 font-medium cursor-pointer flex-shrink-0"
                            data-prompt={prompt.imagePrompt}
                            onclick={`navigator.clipboard.writeText('${prompt.imagePrompt.replace(/'/g, "\\'")}'); this.textContent='‚úì Copiado'; setTimeout(() => this.textContent='Copiar', 2000);`}
                          >
                            Copiar
                          </button>
                        </div>
                        <div class="prompt-text text-sm text-gray-800 leading-relaxed font-mono bg-white p-3 rounded border border-gray-300 flex-1 overflow-y-auto min-h-[80px] max-h-[200px]">
                          {prompt.imagePrompt}
                        </div>
                      </div>

                      <div className="flex items-center justify-between text-xs mb-3 flex-wrap gap-2">
                        <div className="flex gap-3 text-gray-600 flex-wrap">
                          <span className="flex items-center gap-1 whitespace-nowrap">
                            <span>‚è∞</span>
                            {prompt.costImpact.timeHours}h/sem
                          </span>
                          <span className="flex items-center gap-1 whitespace-nowrap">
                            <span>üí∞</span>
                            ${prompt.costImpact.moneyCost}/mes
                          </span>
                          <span className="flex items-center gap-1 whitespace-nowrap">
                            <span>‚ö†Ô∏è</span>
                            {prompt.costImpact.errorRate}%
                          </span>
                        </div>
                      </div>

                      <div className="pt-3 border-t border-gray-200 flex-shrink-0">
                        <div className="flex flex-col gap-1">
                          <span className="text-xs text-gray-500 font-medium">Archivo sugerido:</span>
                          <code class="file-name text-xs bg-gray-100 text-gray-800 px-2 py-1.5 rounded font-mono break-all">
                            {prompt.suggestedFileName}
                          </code>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          ))}

          <div className="mt-8 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-6 shadow-sm">
            <h3 className="text-lg font-semibold text-blue-900 mb-3 flex items-center gap-2">
              <span>üìã</span>
              Instrucciones para generar im√°genes
            </h3>
            <ol className="list-decimal list-inside space-y-2 text-sm text-blue-900">
              <li>Copia cada prompt usando el bot√≥n "Copiar" y √∫salo en DALL-E, Midjourney, Stable Diffusion u otra herramienta de IA</li>
              <li>Genera la imagen seg√∫n el prompt</li>
              <li>Guarda la imagen con el nombre sugerido en la carpeta <code class="bg-blue-100 px-1 py-0.5 rounded">/public/images/diagnosticos/</code></li>
              <li>Las im√°genes se asociar√°n autom√°ticamente a cada insight cuando el wizard las genere</li>
            </ol>
          </div>
        </div>
      </div>
    </div>
  </AdminGuard>
</Layout>

<style>
  code {
    font-family: 'Courier New', monospace;
    background-color: #f3f4f6;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
  }
  
  .prompt-text {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
  }
  
  .prompt-text::-webkit-scrollbar {
    width: 6px;
  }
  
  .prompt-text::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
  }
  
  .prompt-text::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
  }
  
  .prompt-text::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }
  
  .copy-prompt-btn {
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .copy-prompt-btn:hover {
    text-decoration: underline;
  }
</style>

