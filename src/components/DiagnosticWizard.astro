---
// Componente de Diagn√≥stico Estrat√©gico Interactivo
// Wizard/Stepper para calificar empresas de forma visual
---

<section id="diagnostico-estrategico" class="diagnostic-wizard-section">
  <div class="diagnostic-container">
    <div class="diagnostic-header">
      <h2 class="diagnostic-title">Diagn√≥stico Estrat√©gico</h2>
      <p class="diagnostic-subtitle">Eval√∫a tu empresa y descubre c√≥mo podemos ayudarte</p>
    </div>

    <div class="wizard-container" id="wizard-container">
      <!-- Paso 1: Tipo de empresa -->
      <div class="wizard-step active" data-step="1">
        <div class="step-header">
          <span class="step-number">1</span>
          <h3 class="step-title">¬øQu√© tipo de empresa eres?</h3>
          <p class="step-description">Selecciona la opci√≥n que mejor describe tu negocio</p>
        </div>
        <div class="cards-grid">
          <button class="option-card" data-value="restaurante">
            <div class="card-icon">üçΩÔ∏è</div>
            <h4 class="card-title">Restaurante, caf√© o bar</h4>
            <p class="card-description">Tengo un restaurante, caf√©, bar o negocio de comida</p>
          </button>
          <button class="option-card" data-value="servicio-tecnico">
            <div class="card-icon">üîß</div>
            <h4 class="card-title">Servicio t√©cnico o taller</h4>
            <p class="card-description">Reparo celulares, electrodom√©sticos, motos o autos</p>
          </button>
          <button class="option-card" data-value="fabrica">
            <div class="card-icon">üè≠</div>
            <h4 class="card-title">F√°brica o muebler√≠a</h4>
            <p class="card-description">Fabrico muebles, productos a medida o cotizo por medidas</p>
          </button>
          <button class="option-card" data-value="otro">
            <div class="card-icon">üíº</div>
            <h4 class="card-title">Otro tipo de negocio</h4>
            <p class="card-description">Tengo otro tipo de empresa o negocio</p>
          </button>
        </div>
      </div>

      <!-- Paso 2: Nivel digital actual -->
      <div class="wizard-step" data-step="2">
        <div class="step-header">
          <span class="step-number">2</span>
          <h3 class="step-title">¬øCu√°l es tu nivel digital actual?</h3>
          <p class="step-description">Eval√∫a tu presencia digital actual</p>
        </div>
        <div class="cards-grid">
          <button class="option-card" data-value="nada">
            <div class="card-icon">üìù</div>
            <h4 class="card-title">Trabajo todo en papel</h4>
            <p class="card-description">Anoto pedidos, √≥rdenes o cotizaciones a mano</p>
          </button>
          <button class="option-card" data-value="basica">
            <div class="card-icon">üì±</div>
            <h4 class="card-title">Tengo una p√°gina web b√°sica</h4>
            <p class="card-description">Tengo web pero no hace mucho o est√° desactualizada</p>
          </button>
          <button class="option-card" data-value="funciona">
            <div class="card-icon">‚öôÔ∏è</div>
            <h4 class="card-title">Funciona, pero quiero mejorar</h4>
            <p class="card-description">Tengo sistemas pero quiero optimizar o automatizar m√°s</p>
          </button>
          <button class="option-card" data-value="avanzada">
            <div class="card-icon">üéØ</div>
            <h4 class="card-title">Ya tengo sistemas digitales</h4>
            <p class="card-description">Funciona bien, busco algo m√°s avanzado o espec√≠fico</p>
          </button>
        </div>
      </div>

      <!-- Paso 3: Objetivos (m√∫ltiples selecciones) -->
      <div class="wizard-step" data-step="3">
        <div class="step-header">
          <span class="step-number">3</span>
          <h3 class="step-title">¬øQu√© necesitas para tu negocio?</h3>
          <p class="step-description">Puedes seleccionar una o m√°s opciones</p>
        </div>
        <div class="cards-grid">
          <button class="option-card multi-select" data-value="organizar">
            <div class="card-icon">‚ö°</div>
            <h4 class="card-title">Sistema de gesti√≥n</h4>
            <p class="card-description">Organizar procesos, inventario, clientes y ventas</p>
            <div class="check-icon">‚úì</div>
          </button>
          <button class="option-card multi-select" data-value="presencia">
            <div class="card-icon">üåê</div>
            <h4 class="card-title">P√°gina web</h4>
            <p class="card-description">Tener presencia profesional en internet</p>
            <div class="check-icon">‚úì</div>
          </button>
          <button class="option-card multi-select" data-value="ventas">
            <div class="card-icon">üìà</div>
            <h4 class="card-title">Vender m√°s</h4>
            <p class="card-description">Aumentar ventas y conseguir m√°s clientes</p>
            <div class="check-icon">‚úì</div>
          </button>
          <button class="option-card multi-select" data-value="automatizar">
            <div class="card-icon">ü§ñ</div>
            <h4 class="card-title">Automatizar</h4>
            <p class="card-description">Que el sistema haga procesos autom√°ticamente</p>
            <div class="check-icon">‚úì</div>
          </button>
        </div>
        <div class="step-footer">
          <button class="btn-continue" id="continue-step-3" disabled>Continuar</button>
        </div>
      </div>

      <!-- Paso 4: Tama√±o de empresa -->
      <div class="wizard-step" data-step="4">
        <div class="step-header">
          <span class="step-number">4</span>
          <h3 class="step-title">¬øCu√°ntas personas trabajan en tu empresa?</h3>
          <p class="step-description">Tama√±o de tu equipo</p>
        </div>
        <div class="cards-grid">
          <button class="option-card" data-value="1-5">
            <div class="card-icon">üë§</div>
            <h4 class="card-title">1-5 personas</h4>
            <p class="card-description">Equipo peque√±o</p>
          </button>
          <button class="option-card" data-value="6-20">
            <div class="card-icon">üë•</div>
            <h4 class="card-title">6-20 personas</h4>
            <p class="card-description">Equipo mediano</p>
          </button>
          <button class="option-card" data-value="21-100">
            <div class="card-icon">üè¢</div>
            <h4 class="card-title">21-100 personas</h4>
            <p class="card-description">Empresa establecida</p>
          </button>
          <button class="option-card" data-value="100+">
            <div class="card-icon">üèõÔ∏è</div>
            <h4 class="card-title">+100 personas</h4>
            <p class="card-description">Gran empresa</p>
          </button>
        </div>
      </div>

      <!-- Paso 5: Preguntas adicionales (solo si tipo de negocio es "otro") -->
      <div class="wizard-step" data-step="5" id="step-5-questions">
        <div class="step-header">
          <span class="step-number">5</span>
          <h3 class="step-title">Cu√©ntanos m√°s sobre tu negocio</h3>
          <p class="step-description">Esto nos ayuda a entender mejor qu√© necesitas</p>
        </div>
        <div class="cards-grid">
          <button class="option-card multi-select" data-value="stock">
            <div class="card-icon">üì¶</div>
            <h4 class="card-title">Manejo de stock</h4>
            <p class="card-description">Necesito controlar inventario y proveedores</p>
            <div class="check-icon">‚úì</div>
          </button>
          <button class="option-card multi-select" data-value="sucursales">
            <div class="card-icon">üè™</div>
            <h4 class="card-title">M√∫ltiples sucursales</h4>
            <p class="card-description">Tengo m√°s de una ubicaci√≥n</p>
            <div class="check-icon">‚úì</div>
          </button>
          <button class="option-card multi-select" data-value="empleados">
            <div class="card-icon">üë•</div>
            <h4 class="card-title">Gesti√≥n de empleados</h4>
            <p class="card-description">Necesito controlar horarios y tareas</p>
            <div class="check-icon">‚úì</div>
          </button>
          <button class="option-card multi-select" data-value="catalogo">
            <div class="card-icon">üõçÔ∏è</div>
            <h4 class="card-title">Cat√°logo de productos</h4>
            <p class="card-description">Quiero mostrar productos en l√≠nea</p>
            <div class="check-icon">‚úì</div>
          </button>
        </div>
        <div class="step-footer">
          <button class="btn-continue" id="continue-step-5">Continuar</button>
        </div>
      </div>

      <!-- Paso 6: Informaci√≥n de contacto (opcional) -->
      <div class="wizard-step" data-step="6" id="step-6-contact">
        <div class="step-header">
          <span class="step-number">6</span>
          <h3 class="step-title">Informaci√≥n de contacto (opcional)</h3>
          <p class="step-description">Nos ayuda a personalizar mejor tu resultado</p>
        </div>
        <div class="contact-form">
          <div class="form-group">
            <label class="form-label">Tu nombre</label>
            <input type="text" class="form-input" id="contact-name" placeholder="Ej: Juan P√©rez">
          </div>
          <div class="form-group">
            <label class="form-label">Nombre de tu empresa</label>
            <input type="text" class="form-input" id="contact-company" placeholder="Ej: Mi Empresa S.A.">
          </div>
        </div>
        <div class="step-footer">
          <button class="btn-continue" id="continue-step-6">Ver mi resultado</button>
        </div>
      </div>

      <!-- Paso 7: An√°lisis -->
      <div class="wizard-step" data-step="7">
        <div class="analysis-container">
          <div class="analysis-icon">üîç</div>
          <h3 class="analysis-title">Analizando tu informaci√≥n...</h3>
          <p class="analysis-text">Verificando compatibilidad y oportunidades</p>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Barra de progreso general -->
    <div class="wizard-progress">
      <div class="progress-steps">
        <div class="progress-step active" data-progress="1"></div>
        <div class="progress-step" data-progress="2"></div>
        <div class="progress-step" data-progress="3"></div>
        <div class="progress-step" data-progress="4"></div>
      </div>
    </div>
  </div>
</section>

<style>
  .diagnostic-wizard-section {
    padding: 4rem 1rem;
    background: var(--color-elephant-white, #F6F5F2);
    min-height: 100vh;
    position: relative;
  }

  .diagnostic-container {
    max-width: 900px;
    margin: 0 auto;
  }

  .diagnostic-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .diagnostic-title {
    font-family: 'Libre Baskerville', serif;
    font-size: clamp(2rem, 5vw, 3rem);
    font-weight: 700;
    color: var(--color-graphite-dark, #2B2B2B);
    margin-bottom: 1rem;
  }

  .diagnostic-subtitle {
    font-size: clamp(1rem, 2.5vw, 1.25rem);
    color: var(--color-grey-medium, #9A9A97);
    max-width: 600px;
    margin: 0 auto;
  }

  .wizard-container {
    position: relative;
    min-height: 500px;
  }

  .wizard-step {
    display: none;
    animation: fadeIn 0.4s ease-in-out;
  }

  .wizard-step.active {
    display: block;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .step-header {
    text-align: center;
    margin-bottom: 2.5rem;
  }

  .step-number {
    display: inline-block;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--color-graphite-dark, #2B2B2B);
    color: white;
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 50px;
    margin-bottom: 1rem;
  }

  .step-title {
    font-family: 'Libre Baskerville', serif;
    font-size: clamp(1.5rem, 4vw, 2rem);
    font-weight: 700;
    color: var(--color-graphite-dark, #2B2B2B);
    margin-bottom: 0.5rem;
  }

  .step-description {
    font-size: 1rem;
    color: var(--color-grey-medium, #9A9A97);
  }

  .cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
  }

  .option-card {
    background: white;
    border: 2px solid var(--color-grey-light, #E5E5E3);
    border-radius: 16px;
    padding: 2rem 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    min-height: 200px;
  }

  .option-card:hover {
    border-color: var(--color-graphite-dark, #2B2B2B);
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
  }

  .option-card.selected {
    border-color: var(--color-graphite-dark, #2B2B2B);
    background: var(--color-graphite-dark, #2B2B2B);
    color: white;
  }

  .option-card.selected .card-title,
  .option-card.selected .card-description {
    color: white;
  }

  .option-card.multi-select {
    position: relative;
  }

  .check-icon {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--color-grey-light, #E5E5E3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    font-weight: bold;
    color: transparent;
    transition: all 0.3s ease;
  }

  .option-card.selected .check-icon {
    background: var(--color-white-pure, #FFFFFF);
    color: var(--color-graphite-dark, #2B2B2B);
  }

  .step-footer {
    margin-top: 2rem;
    text-align: center;
  }

  .btn-continue {
    padding: 1rem 2.5rem;
    background: var(--color-graphite-dark, #2B2B2B);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-continue:hover:not(:disabled) {
    background: var(--color-black-deep, #111111);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .btn-continue:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn-continue.enabled {
    opacity: 1;
    cursor: pointer;
  }

  .btn-continue:not(:disabled):hover {
    background: var(--color-black-deep, #111111);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .contact-form {
    max-width: 500px;
    margin: 2rem auto;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-graphite-dark, #2B2B2B);
    margin-bottom: 0.5rem;
  }

  .form-input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid var(--color-grey-light, #E5E5E3);
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
    box-sizing: border-box;
  }

  .form-input:focus {
    outline: none;
    border-color: var(--color-graphite-dark, #2B2B2B);
  }

  .card-icon {
    font-size: 3rem;
    margin-bottom: 0.5rem;
  }

  .card-title {
    font-family: 'Libre Baskerville', serif;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--color-graphite-dark, #2B2B2B);
    margin: 0;
  }

  .card-description {
    font-size: 0.875rem;
    color: var(--color-grey-medium, #9A9A97);
    margin: 0;
    line-height: 1.5;
  }

  /* Paso 5: An√°lisis */
  .analysis-container {
    text-align: center;
    padding: 4rem 2rem;
  }

  .analysis-icon {
    font-size: 4rem;
    margin-bottom: 1.5rem;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.1);
    }
  }

  .analysis-title {
    font-family: 'Libre Baskerville', serif;
    font-size: clamp(1.5rem, 4vw, 2rem);
    font-weight: 700;
    color: var(--color-graphite-dark, #2B2B2B);
    margin-bottom: 0.5rem;
  }

  .analysis-text {
    font-size: 1rem;
    color: var(--color-grey-medium, #9A9A97);
    margin-bottom: 2rem;
  }

  .progress-bar {
    width: 100%;
    max-width: 400px;
    height: 8px;
    background: var(--color-grey-light, #E5E5E3);
    border-radius: 4px;
    margin: 0 auto;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: var(--color-graphite-dark, #2B2B2B);
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 4px;
  }

  /* Paso 6: Resultado */
  .result-container {
    text-align: center;
    padding: 3rem 2rem;
  }

  .result-success,
  .result-not-qualified {
    max-width: 600px;
    margin: 0 auto;
  }

  .result-icon {
    font-size: 4rem;
    margin-bottom: 1.5rem;
  }

  .result-title {
    font-family: 'Libre Baskerville', serif;
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    font-weight: 700;
    color: var(--color-graphite-dark, #2B2B2B);
    margin-bottom: 1rem;
  }

  .result-message {
    font-size: 1.125rem;
    color: var(--color-grey-medium, #9A9A97);
    margin-bottom: 2rem;
    line-height: 1.6;
  }

  .result-cta-group {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 2rem;
  }

  .result-form {
    margin-top: 2rem;
    text-align: left;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-graphite-dark, #2B2B2B);
    margin-bottom: 0.5rem;
  }

  .form-input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid var(--color-grey-light, #E5E5E3);
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
    box-sizing: border-box;
  }

  .form-input:focus {
    outline: none;
    border-color: var(--color-graphite-dark, #2B2B2B);
  }

  .btn-submit {
    width: 100%;
    padding: 1rem 2rem;
    background: var(--color-graphite-dark, #2B2B2B);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-submit:hover {
    background: var(--color-black-deep, #111111);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  /* Barra de progreso */
  .wizard-progress {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-grey-light, #E5E5E3);
  }

  .progress-steps {
    display: flex;
    justify-content: center;
    gap: 1rem;
  }

  .progress-step {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--color-grey-light, #E5E5E3);
    transition: all 0.3s ease;
  }

  .progress-step.active {
    background: var(--color-graphite-dark, #2B2B2B);
    transform: scale(1.2);
  }

  .progress-step.completed {
    background: var(--color-graphite-dark, #2B2B2B);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .diagnostic-wizard-section {
      padding: 2rem 1rem;
    }

    .cards-grid {
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .option-card {
      min-height: 160px;
      padding: 1.5rem 1rem;
    }

    .card-icon {
      font-size: 2.5rem;
    }
  }
</style>

<script>
  // Estado del wizard
  let currentStep = 1;
  const totalSteps = 7;
  const answers: Record<number, string | string[]> = {};
  const contactInfo: { name?: string; company?: string } = {};

  // Inicializaci√≥n
  document.addEventListener('DOMContentLoaded', () => {
    initWizard();
  });

  function initWizard() {
    // Agregar event listeners a las cards
    const cards = document.querySelectorAll('.option-card');
    cards.forEach(card => {
      card.addEventListener('click', handleCardClick);
    });

    // Configurar botones de continuar
    setupContinueButtons();

    // Scroll suave al llegar desde el hero
    if (window.location.hash === '#diagnostico-estrategico') {
      setTimeout(() => {
        document.getElementById('diagnostico-estrategico')?.scrollIntoView({ 
          behavior: 'smooth',
          block: 'start'
        });
      }, 100);
    }
  }

  function setupContinueButtons() {
    const continueBtn3 = document.getElementById('continue-step-3');
    const continueBtn5 = document.getElementById('continue-step-5');
    const continueBtn6 = document.getElementById('continue-step-6');

    continueBtn3?.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      const objetivos = answers[3] as string[];
      console.log('Continue button 3 clicked, objetivos:', objetivos, 'Type:', typeof objetivos, 'Is Array:', Array.isArray(objetivos));
      
      if (objetivos && Array.isArray(objetivos) && objetivos.length > 0) {
        console.log('Advancing to next step...');
        nextStep();
      } else {
        console.warn('No objectives selected, cannot continue');
        alert('Por favor selecciona al menos una opci√≥n antes de continuar');
      }
    });

    continueBtn5?.addEventListener('click', () => {
      nextStep();
    });

    continueBtn6?.addEventListener('click', () => {
      // Guardar informaci√≥n de contacto
      const nameInput = document.getElementById('contact-name') as HTMLInputElement;
      const companyInput = document.getElementById('contact-company') as HTMLInputElement;
      
      if (nameInput?.value) {
        contactInfo.name = nameInput.value;
      }
      if (companyInput?.value) {
        contactInfo.company = companyInput.value;
      }
      
      nextStep();
    });
  }

  function handleCardClick(e: Event) {
    const card = e.currentTarget as HTMLElement;
    const step = currentStep;
    const value = card.getAttribute('data-value') || '';
    const isMultiSelect = card.classList.contains('multi-select');

    if (isMultiSelect) {
      // Manejar selecci√≥n m√∫ltiple
      if (!answers[step]) {
        answers[step] = [];
      }
      const currentAnswers = answers[step] as string[];
      
      if (card.classList.contains('selected')) {
        // Deseleccionar
        card.classList.remove('selected');
        const index = currentAnswers.indexOf(value);
        if (index > -1) {
          currentAnswers.splice(index, 1);
        }
      } else {
        // Seleccionar
        card.classList.add('selected');
        if (!currentAnswers.includes(value)) {
          currentAnswers.push(value);
        }
      }
      
      answers[step] = currentAnswers;
      
      // Habilitar bot√≥n continuar si hay al menos una selecci√≥n
      const continueBtn = document.getElementById(`continue-step-${step}`);
      if (continueBtn) {
        const btn = continueBtn as HTMLButtonElement;
        const hasSelections = currentAnswers.length > 0;
        btn.disabled = !hasSelections;
        
        // Agregar clase visual para feedback
        if (hasSelections) {
          btn.classList.add('enabled');
          btn.style.opacity = '1';
          btn.style.cursor = 'pointer';
        } else {
          btn.classList.remove('enabled');
          btn.style.opacity = '0.5';
          btn.style.cursor = 'not-allowed';
        }
        
        // Debug: Log para verificar
        console.log('Step', step, 'Answers:', currentAnswers, 'Length:', currentAnswers.length, 'Button disabled:', btn.disabled);
      }
    } else {
      // Selecci√≥n √∫nica (comportamiento original)
      answers[step] = value;
      
      // Visual feedback
      const cards = document.querySelectorAll(`[data-step="${step}"] .option-card`);
      cards.forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');

      // Avanzar al siguiente paso despu√©s de un breve delay
      setTimeout(() => {
        nextStep();
      }, 300);
    }
  }

  function nextStep() {
    if (currentStep < totalSteps) {
      // Ocultar paso actual
      const currentStepEl = document.querySelector(`[data-step="${currentStep}"]`);
      currentStepEl?.classList.remove('active');

      // Actualizar barra de progreso
      updateProgressBar(currentStep, false);

      currentStep++;

      // L√≥gica de flujo condicional
      if (currentStep === 5) {
        // Paso 5: Preguntas adicionales (solo si tipo de negocio es "otro")
        const tipoEmpresa = answers[1] as string;
        if (tipoEmpresa === 'otro') {
          const step5El = document.getElementById('step-5-questions');
          if (step5El) {
            step5El.classList.add('active');
            updateProgressBar(currentStep - 1, true);
            return;
          }
        } else {
          // Si no es "otro", saltar al paso 6 (contacto)
          currentStep = 6;
        }
      }

      if (currentStep === 6) {
        // Paso 6: Informaci√≥n de contacto
        const step6El = document.getElementById('step-6-contact');
        if (step6El) {
          step6El.classList.add('active');
          updateProgressBar(currentStep - 1, true);
          return;
        }
      }

      if (currentStep === 7) {
        // Paso 7: An√°lisis
        showAnalysisStep();
        return;
      }

      // Mostrar siguiente paso normal
      const nextStepEl = document.querySelector(`[data-step="${currentStep}"]`);
      if (nextStepEl) {
        nextStepEl.classList.add('active');
        updateProgressBar(currentStep - 1, true);
      }
    }
  }

  function showAnalysisStep() {
    console.log('showAnalysisStep called');
    const step7 = document.querySelector('[data-step="7"]');
    if (step7) {
      step7.classList.add('active');
      updateProgressBar(6, true);

      // Animar barra de progreso
      const progressFill = document.getElementById('progress-fill');
      if (progressFill) {
        let width = 0;
        const interval = setInterval(() => {
          width += 2;
          progressFill.style.width = width + '%';
          if (width >= 100) {
            clearInterval(interval);
            console.log('Progress bar completed, redirecting to result...');
            setTimeout(() => {
              // Despu√©s del an√°lisis, ir directamente al resultado
              console.log('Calling showResultStep from analysis step');
              showResultStep();
            }, 500);
          }
        }, 30);
      } else {
        console.warn('Progress fill element not found, going directly to result');
        setTimeout(() => {
          showResultStep();
        }, 1000);
      }
    } else {
      // Si no hay paso 7, ir directamente al resultado
      console.warn('Step 7 not found, going directly to result');
      setTimeout(() => {
        showResultStep();
      }, 500);
    }
  }

  async function showResultStep() {
    console.log('=== showResultStep called ===');
    console.log('Current answers object:', answers);
    console.log('Answers keys:', Object.keys(answers));
    console.log('Contact info:', contactInfo);
    
    // Verificar que tenemos respuestas m√≠nimas
    const requiredSteps = [1, 2, 3, 4];
    const missingSteps = requiredSteps.filter(step => !answers[step]);
    
    if (missingSteps.length > 0) {
      console.error('Missing required answers:', {
        missing: missingSteps,
        step1: answers[1],
        step2: answers[2],
        step3: answers[3],
        step4: answers[4]
      });
      alert('Error: Faltan respuestas. Por favor, completa el diagn√≥stico nuevamente.');
      return;
    }
    
    // Normalizar respuestas para el backend
    // El backend espera: tipoEmpresa, nivelDigital, objetivos (array), tamano, necesidadesAdicionales (array opcional)
    const diagnosticData = {
      tipoEmpresa: String(answers[1]),
      nivelDigital: String(answers[2]),
      objetivos: Array.isArray(answers[3]) ? answers[3] : [String(answers[3])],
      tamano: String(answers[4]),
      necesidadesAdicionales: answers[5] ? (Array.isArray(answers[5]) ? answers[5] : [String(answers[5])]) : [],
      nombre: contactInfo.name || undefined,
      empresa: contactInfo.company || undefined,
    };
    
    console.log('Sending diagnostic data to backend:', diagnosticData);
    
    // Mostrar estado de carga
    const step6 = document.querySelector('[data-step="6"]');
    if (step6) {
      step6.classList.add('active');
      const resultContainer = document.getElementById('result-container');
      if (resultContainer) {
        resultContainer.innerHTML = `
          <div style="text-align: center; padding: 3rem;">
            <div class="analysis-spinner"></div>
            <p style="margin-top: 1.5rem; font-size: 1.125rem; color: #9A9A97;">
              Guardando tu diagn√≥stico...
            </p>
          </div>
        `;
      }
    }
    
    try {
      // Importar el cliente del backend din√°micamente
      // El path es relativo desde src/components/ hacia src/utils/
      const { createDiagnostic } = await import('../utils/backendClient');
      
      // Llamar al backend Nest.js
      const response = await createDiagnostic(diagnosticData);
      
      console.log('Backend response:', response);
      
      if (response.success && response.data && response.data.id) {
        // Redirigir a la p√°gina din√°mica con el ID
        const diagnosticId = response.data.id;
        console.log('=== REDIRECTING TO DYNAMIC PAGE ===');
        console.log('Diagnostic ID:', diagnosticId);
        console.log('Redirecting to:', `/diagnostico/${diagnosticId}`);
        
        window.location.href = `/diagnostico/${diagnosticId}`;
      } else {
        throw new Error('No se recibi√≥ ID del diagn√≥stico del backend');
      }
    } catch (error: any) {
      console.error('Error creating diagnostic:', error);
      
      // Detectar si el error es por backend no disponible
      const isBackendUnavailable = error.message?.includes('backend no est√° disponible') ||
                                   error.message?.includes('ERR_CONNECTION_REFUSED') ||
                                   error.message?.includes('Failed to fetch');
      
      // Ocultar el paso de an√°lisis y mostrar el error
      const step6 = document.querySelector('[data-step="6"]');
      if (step6) {
        step6.classList.remove('active');
      }
      
      // Mostrar error al usuario
      const resultContainer = document.getElementById('result-container');
      if (!resultContainer) {
        console.error('No se encontr√≥ el contenedor de resultados');
        alert(`Error al procesar el diagn√≥stico: ${error.message || 'Error desconocido'}`);
        return;
      }
      
      // Funci√≥n helper para escapar HTML
      function escapeHtml(text: string): string {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      if (isBackendUnavailable) {
          resultContainer.innerHTML = `
            <div class="result-error">
              <div class="result-icon-large">üîå</div>
              <h2 class="result-title">Servidor Backend No Disponible</h2>
              <p class="result-subtitle">
                El servidor backend no est√° corriendo. Para usar el diagn√≥stico completo, necesitas iniciar el backend Nest.js.
              </p>
              <div style="background: #f5f5f5; padding: 1.5rem; border-radius: 8px; margin: 2rem 0; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: #2B2B2B;">Instrucciones:</h3>
                <ol style="margin: 0; padding-left: 1.5rem; line-height: 1.8; color: #4A4A4A;">
                  <li>Abre una nueva terminal</li>
                  <li>Navega a la carpeta backend: <code style="background: #e5e5e3; padding: 0.2rem 0.4rem; border-radius: 4px;">cd backend</code></li>
                  <li>Inicia el servidor: <code style="background: #e5e5e3; padding: 0.2rem 0.4rem; border-radius: 4px;">npm run start:dev</code></li>
                  <li>Espera a ver: <code style="background: #e5e5e3; padding: 0.2rem 0.4rem; border-radius: 4px;">üöÄ Backend API running on: http://localhost:3000/api</code></li>
                  <li>Vuelve aqu√≠ y recarga la p√°gina</li>
                </ol>
              </div>
              <div class="cta-group" style="margin-top: 2rem;">
                <a href="/#diagnostico-estrategico" class="btn-cta-primary">
                  Intentar de nuevo
                </a>
                <a href="/soluciones" class="btn-cta-secondary">
                  Ver todas las soluciones
                </a>
              </div>
              <details style="margin-top: 2rem; text-align: left; max-width: 600px; margin: 2rem auto 0; padding: 1rem; background: #f5f5f5; border-radius: 8px;">
                <summary style="cursor: pointer; font-weight: 600;">Detalles t√©cnicos</summary>
                <pre style="margin-top: 0.5rem; white-space: pre-wrap; font-size: 0.75rem; overflow-x: auto;">${error.stack || JSON.stringify(error, null, 2)}</pre>
              </details>
            </div>
          `;
        } else {
          // Error del servidor (500, etc.)
          const errorMessage = error.message || 'Error desconocido';
          resultContainer.innerHTML = `
            <div class="result-error" style="text-align: center; padding: 3rem 2rem;">
              <div class="result-icon-large" style="font-size: 4rem; margin-bottom: 1.5rem;">‚ö†Ô∏è</div>
              <h2 class="result-title" style="font-size: 1.75rem; font-weight: 700; color: #2B2B2B; margin-bottom: 1rem;">Error al procesar el diagn√≥stico</h2>
              <p class="result-subtitle" style="font-size: 1.125rem; color: #9A9A97; margin-bottom: 2rem; line-height: 1.6;">${escapeHtml(errorMessage)}</p>
              <p style="font-size: 0.95rem; color: #6B6B6B; margin-bottom: 2rem;">
                Por favor, revisa los logs del backend para m√°s detalles o intenta de nuevo.
              </p>
              <div class="cta-group" style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-top: 2rem;">
                <a href="/#diagnostico-estrategico" class="btn-cta-primary" style="display: inline-block; padding: 1rem 2rem; background: #2B2B2B; color: #FFFFFF; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.3s ease;">
                  Intentar de nuevo
                </a>
                <a href="/soluciones" class="btn-cta-secondary" style="display: inline-block; padding: 1rem 2rem; background: transparent; color: #2B2B2B; border: 2px solid #2B2B2B; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.3s ease;">
                  Ver todas las soluciones
                </a>
              </div>
              <details style="margin-top: 2rem; text-align: left; max-width: 600px; margin: 2rem auto 0; padding: 1rem; background: #f5f5f5; border-radius: 8px;">
                <summary style="cursor: pointer; font-weight: 600; color: #2B2B2B;">Detalles t√©cnicos</summary>
                <pre style="margin-top: 0.5rem; white-space: pre-wrap; font-size: 0.75rem; overflow-x: auto; color: #4A4A4A;">${escapeHtml(error.stack || JSON.stringify(error, null, 2))}</pre>
              </details>
            </div>
          `;
        }
    }
    
    return; // Salir temprano, la redirecci√≥n maneja el resto

    /* C√≥digo antiguo comentado - ya no se usa porque ahora redirigimos al backend
    const step6Old = document.querySelector('[data-step="6"]');
    step6Old?.classList.add('active');

    const resultContainerOld = document.getElementById('result-container');
    if (!resultContainerOld) return;

    // Calificar respuestas (l√≥gica simple)
    const qualifiesOld = calculateQualification();

    if (qualifiesOld) {
      resultContainerOld.innerHTML = `
        <div class="result-success">
          <div class="result-icon">‚úÖ</div>
          <h3 class="result-title">¬°Tu empresa califica!</h3>
          <p class="result-message">
            Basado en tus respuestas, tu empresa es candidata ideal para un diagn√≥stico estrat√©gico personalizado.
          </p>
          <div class="result-cta-group">
            <a href="${redirectToSolution(answers[1])}" class="btn-submit" style="text-decoration: none; display: inline-block; text-align: center;">
              Ver soluci√≥n para mi negocio
            </a>
            <a href="/contacto" class="btn-submit" style="text-decoration: none; display: inline-block; text-align: center; background: transparent; border: 2px solid var(--color-graphite-dark, #2B2B2B); color: var(--color-graphite-dark, #2B2B2B);">
              Agendar llamada estrat√©gica
            </a>
          </div>
          <form class="result-form" id="contact-form">
            <div class="form-group">
              <label class="form-label">Nombre completo</label>
              <input type="text" class="form-input" name="name" required>
            </div>
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" class="form-input" name="email" required>
            </div>
            <div class="form-group">
              <label class="form-label">Empresa</label>
              <input type="text" class="form-input" name="company" required>
            </div>
            <button type="submit" class="btn-submit">Enviar informaci√≥n</button>
          </form>
        </div>
      `;

      // Agregar listener al formulario
      const formOld = document.getElementById('contact-form');
      formOld?.addEventListener('submit', handleFormSubmit);
    } else {
      resultContainerOld.innerHTML = `
        <div class="result-not-qualified">
          <div class="result-icon">üí°</div>
          <h3 class="result-title">Gracias por tu inter√©s</h3>
          <p class="result-message">
            Actualmente estamos enfocados en empresas que buscan transformaci√≥n digital estrat√©gica. 
            Te invitamos a explorar nuestros recursos o contactarnos para futuras oportunidades.
          </p>
          <div class="result-cta-group">
            <a href="/projects" class="btn-submit" style="text-decoration: none; display: inline-block; text-align: center;">
              Ver casos de √©xito
            </a>
            <a href="/contacto" class="btn-submit" style="text-decoration: none; display: inline-block; text-align: center; background: transparent; border: 2px solid var(--color-graphite-dark, #2B2B2B); color: var(--color-graphite-dark, #2B2B2B);">
              Contacto general
            </a>
          </div>
        </div>
      `;
    }
    */
  }

  // Funci√≥n para redirigir seg√∫n tipo de empresa
  function redirectToSolution(tipoEmpresa: string): string {
    const solutionMap: Record<string, string> = {
      'restaurante': '/soluciones/restaurantes',
      'servicio-tecnico': '/soluciones/servicio-tecnico',
      'fabrica': '/soluciones/cotizador-fabrica',
      'otro': '/soluciones/desarrollo-web'
    };

    return solutionMap[tipoEmpresa] || '/soluciones/desarrollo-web';
  }

  function calculateQualification(): boolean {
    // L√≥gica simple de calificaci√≥n
    // En producci√≥n, esto podr√≠a ser m√°s sofisticado
    const tipoEmpresa = answers[1];
    const nivelDigital = answers[2];
    const objetivo = answers[3];
    const tamano = answers[4];

    // Calificar positivamente si:
    // - Trabaja en papel (nada) - definitivamente necesita soluci√≥n
    // - Busca automatizar o tener presencia
    // - Empresa mediana/grande
    if (nivelDigital === 'nada') {
      return true; // Si trabaja en papel, definitivamente necesita soluci√≥n
    }

    if (objetivo === 'automatizar' || objetivo === 'presencia' || tamano === '21-100' || tamano === '100+') {
      return true;
    }

    // Por defecto, calificar positivamente
    return true;
  }

  function updateProgressBar(step: number, completed: boolean) {
    const progressStep = document.querySelector(`[data-progress="${step}"]`);
    if (progressStep) {
      if (completed) {
        progressStep.classList.add('completed');
        progressStep.classList.remove('active');
      } else {
        progressStep.classList.add('active');
      }
    }
  }

  function handleFormSubmit(e: Event) {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    
    // Aqu√≠ se enviar√≠a a un backend/CRM
    // Por ahora, redirigir a contacto con datos
    const params = new URLSearchParams();
    formData.forEach((value, key) => {
      params.append(key, value.toString());
    });
    
    // Agregar respuestas del diagn√≥stico
    Object.entries(answers).forEach(([step, value]) => {
      params.append(`step${step}`, value);
    });

    window.location.href = `/contacto?${params.toString()}`;
  }
</script>

